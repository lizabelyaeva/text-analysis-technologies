# Отчет о лабораторной работе
## Telegram-бот "КиноНавигатор"
**Выполнили: Беляева Елизавета, Скачко Владислава, РИС-22-3**

---

## 1. Описание решаемой задачи

Целью данной лабораторной работы является разработка Telegram-бота для поиска и рекомендации фильмов с использованием внешнего API. Бот должен предоставлять пользователям удобный интерфейс для:

- Поиска фильмов по названию
- Получения подборок фильмов по жанрам
- Просмотра рейтинговых списков (топ-10 лучших фильмов)
- Получения информации о популярных новинках, топ 10 фильмов и сериалов по просмотрам за 2025 год
- Получения случайных рекомендаций с учетом качества фильмов
- Отслеживания персональной статистики использования

Основные требования к решению:
- Многопользовательский режим работы
- Интеграция с внешним API (Кинопоиск)
- Применение нетривиальных алгоритмов обработки данных
- Фильтрация и сортировка результатов по качественным критериям
- Удобный пользовательский интерфейс с клавиатурами

---

## 2. Используемые инструменты и технологии

### 2.1. Язык программирования и библиотеки

- **Python 3.11** — основной язык разработки
- **aiogram 3.3.0** — асинхронный фреймворк для создания Telegram-ботов
- **requests 2.31.0** — библиотека для выполнения HTTP-запросов к API
- **aiohttp 3.9.1** — асинхронная HTTP-библиотека (используется aiogram)

### 2.2. Внешние сервисы

- **Telegram Bot API** — платформа для создания и работы бота
- **Kinopoisk API (v1.4)** — внешний API для получения данных о фильмах, включая:
  - Поиск фильмов по названию
  - Фильтрацию по жанрам и рейтингам
  - Получение информации о популярности и рейтингах

### 2.3. Архитектурные решения

Проект организован по модульному принципу с разделением ответственности:
- `bot.py` — основная логика бота и обработчики команд
- `api_client.py` — абстракция для работы с внешним API
- `filters.py` — алгоритмы обработки и анализа данных
- `user_storage.py` — управление данными пользователей
- `config.py` — конфигурация и константы

---

## 3. Алгоритм решения

### 3.1. Архитектура системы

Система построена на основе асинхронной архитектуры с использованием паттерна разделения ответственности:

1. **Уровень представления** (`bot.py`): обработка команд пользователя, формирование ответов, управление клавиатурами
2. **Уровень бизнес-логики** (`filters.py`): обработка данных, фильтрация, сортировка, анализ
3. **Уровень данных** (`api_client.py`, `user_storage.py`): взаимодействие с внешним API и хранение пользовательских данных
4. **Уровень конфигурации** (`config.py`): централизованное управление настройками

### 3.2. Основные алгоритмы

#### 3.2.1. Взвешенный рейтинг (IMDB Formula)

Для более точной оценки качества фильмов используется формула взвешенного рейтинга, которая учитывает не только средний рейтинг, но и количество голосов:

```
WR = (v/(v+m)) * R + (m/(v+m)) * C
```

где:
- `WR` — взвешенный рейтинг
- `v` — количество голосов за фильм
- `m` — минимальный порог голосов (25000)
- `R` — средний рейтинг фильма
- `C` — средний рейтинг по базе (7.0)

Этот алгоритм позволяет более справедливо сравнивать фильмы с разным количеством оценок, предотвращая ситуацию, когда фильм с 10 оценками и рейтингом 9.0 оказывается выше классического фильма с рейтингом 8.5 и миллионом оценок.

#### 3.2.2. Многоуровневая фильтрация

При получении результатов от API применяется последовательная фильтрация:

1. **Фильтрация по рейтингу**: отбираются только фильмы с рейтингом выше заданного порога (по умолчанию 7.0)
2. **Фильтрация по количеству голосов**: исключаются фильмы с недостаточным количеством оценок (минимум 1000) для обеспечения надежности данных
3. **Дедупликация**: удаление повторяющихся записей по уникальному идентификатору
4. **Сортировка**: упорядочивание по взвешенному рейтингу для наиболее качественных рекомендаций

#### 3.2.3. Анализ данных о фильме

Для каждого фильма выполняется автоматический анализ, который включает:

- **Определение популярности**: на основе количества голосов (очень популярный > 500000, популярный > 100000, известный > 10000)
- **Оценка качества**: категоризация по рейтингу (шедевр ≥ 8.5, отличный ≥ 8.0, хороший ≥ 7.5)
- **Определение эпохи**: классификация по году выпуска (новинка, современный, 2000-х, 90-х, классика)

#### 3.2.4. Многопользовательский режим

Для каждого пользователя создается отдельная запись в памяти, которая хранит:
- Историю поиска (последние 20 запросов)
- Предпочтения по жанрам
- Статистику активности (количество запросов, дата первого визита)
- Время последней активности

Данные изолированы по идентификатору пользователя Telegram, что обеспечивает корректную работу в многопользовательском режиме.

### 3.3. Основные функции бота

1. **Поиск фильма** (`/movie`): поиск по названию с фильтрацией по качеству, вывод до 3 наиболее релевантных результатов
2. **Подборка по жанру** (`/genre`): получение топ-5 фильмов выбранного жанра с применением взвешенного рейтинга
3. **Топ фильмов** (`/top`): формирование списка топ-10 лучших фильмов с подробной информацией
4. **Популярные** (`/popular`): список популярных новинок текущего года, отсортированных по количеству просмотров
5. **Случайная рекомендация** (`/random`): выбор случайного качественного фильма (рейтинг > 7.0)
6. **Статистика** (`/stats`): персональная статистика пользователя

### 3.4. Пользовательский интерфейс

Бот использует два типа клавиатур:
- **Reply-клавиатура**: основные действия (поиск, топ, случайный фильм и т.д.)
- **Inline-клавиатура**: выбор жанров при запросе подборки

Все сообщения форматируются с использованием HTML-разметки для улучшения читаемости.

---

## 4. Возникшие трудности и их решение

### 4.1. Проблема с ограничениями API

**Трудность**: API Кинопоиска имеет ограничения на количество запросов и может возвращать неполные данные (отсутствие описаний, постеров, некорректные рейтинги).

**Решение**: 
- Реализована обработка отсутствующих данных с использованием значений по умолчанию
- Добавлена проверка наличия данных перед их использованием
- При отсутствии основного названия используется альтернативное
- Реализована обработка ошибок с информативными сообщениями для пользователя

### 4.2. Фильтрация и сортировка результатов

**Трудность**: API возвращает результаты, которые могут содержать фильмы с низким рейтингом или недостаточным количеством оценок, что снижает качество рекомендаций.

**Решение**:
- Разработан многоуровневый алгоритм фильтрации, который последовательно применяет критерии качества
- Реализован алгоритм взвешенного рейтинга для более справедливого сравнения фильмов
- Добавлена дедупликация для исключения повторяющихся записей
- Настроены оптимальные пороговые значения (рейтинг ≥ 7.0, голоса ≥ 1000)

### 4.3. Форматирование текста для Telegram

**Трудность**: Telegram имеет ограничения на HTML-разметку и может некорректно обрабатывать некоторые символы и теги, что приводит к ошибкам при отправке сообщений.

**Решение**:
- Реализована функция очистки HTML от недопустимых тегов
- Добавлена обработка специальных символов (например, `<`, `>`, `&`)
- Использованы только поддерживаемые Telegram HTML-теги (`<b>`, `<i>`, `<code>`)
- Реализована обрезка длинных описаний для предотвращения превышения лимитов

### 4.4. Управление состоянием пользователей

**Трудность**: Необходимо обеспечить изоляцию данных между пользователями и эффективное хранение истории запросов без использования внешней базы данных.

**Решение**:
- Реализован класс `UserStorage` с использованием словаря для хранения данных в памяти
- Каждый пользователь идентифицируется по уникальному ID Telegram
- История поиска ограничена последними 20 записями для оптимизации памяти
- Данные автоматически создаются при первом обращении пользователя

### 4.5. Асинхронная обработка запросов

**Трудность**: При работе с внешним API необходимо обеспечить неблокирующую обработку запросов для поддержания отзывчивости бота при множественных одновременных пользователях.

**Решение**:
- Использован асинхронный фреймворк aiogram для обработки запросов
- Реализованы асинхронные обработчики команд
- Добавлены задержки между отправкой множественных сообщений для предотвращения ограничений Telegram API
- Настроено логирование для отслеживания ошибок и производительности

### 4.6. Оптимизация запросов к API

**Трудность**: Избыточные запросы к API могут привести к превышению лимитов и замедлению работы бота.

**Решение**:
- Оптимизированы параметры запросов (ограничение количества результатов, использование фильтров на стороне API)
- Реализовано кэширование пользовательских данных в памяти
- Добавлена обработка таймаутов при запросах к API
- Настроены оптимальные значения лимитов для каждого типа запроса

---


## 5. Инструкция по запуску

### Требования:
- Python 3.11 или выше
- Telegram Bot Token (получить у @BotFather)
- Kinopoisk API Key (получить на https://kinopoisk.dev/)

### Установка:

1. Клонировать репозиторий или скачать файлы проекта
2. Установить зависимости:
   ```bash
   pip install -r requirements.txt
   ```
3. Настроить `config.py`:
   - Указать `BOT_TOKEN` от Telegram Bot
   - Указать `KINOPOISK_API_KEY` от Kinopoisk API
4. Запустить бота:
   ```bash
   python bot.py
   ```

### Использование:

После запуска бот будет доступен в Telegram. Используйте команду `/start` для начала работы и `/help` для просмотра всех доступных команд.

---

## 7. Заключение

В ходе выполнения лабораторной работы были изучены и применены на практике:
- Работа с асинхронными фреймворками (aiogram)
- Интеграция с внешними REST API
- Разработка алгоритмов обработки и анализа данных
- Проектирование многопользовательских систем
- Обработка ошибок и граничных случаев

Разработанный бот демонстрирует применение современных подходов к разработке Telegram-ботов и может служить основой для более сложных проектов в области рекомендательных систем.
